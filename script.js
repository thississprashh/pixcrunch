// Language translations
const translations = {
    en: {
        title: "PixCrunch",
        subtitle: "Reduce your image sizes with ease.",
        chooseImage: "Choose the image",
        dragDrop: "or drag and drop here",
        compressImage: "Compress the image",
        reset: "Clear",
        status: "",
        compressing: "Compressing...",
        compressionComplete: "Compression complete!",
        error: "Error compressing images.",
        original: "Original",
        compressed: "Compressed",
        download: "Download",
        footer: "© 2025 PixCrunch. All rights reserved.",
        compressionLevel: "Compression Level:",
        preview: "Preview",
        previewTitle: "Preview",
        outputFormat: "Output Format:"
    },
    hi: {
        title: "PixCrunch",
        subtitle: "अपनी छवियों का आकार आसानी से कम करें",
        chooseImage: "छवि चुनें",
        dragDrop: "या यहाँ खींचें और छोड़ें",
        compressImage: "छवि संपीड़ित करें",
        reset: "रीसेट",
        status: "",
        compressing: "संपीड़न हो रहा है...",
        compressionComplete: "संपीड़न पूरा हुआ!",
        error: "छवियाँ संपीड़ित करने में त्रुटि।",
        original: "मूल",
        compressed: "संपीड़ित",
        download: "डाउनलोड",
        footer: "© 2025 PixCrunch। सभी अधिकार सुरक्षित।",
        compressionLevel: "संपीड़न स्तर:",
        preview: "पूर्वावलोकन",
        previewTitle: "पूर्वावलोकन",
        outputFormat: "आउटपुट प्रारूप:"
    },
    fr: {
        title: "PixCrunch",
        subtitle: "Réduisez facilement la taille de vos images",
        chooseImage: "Choisir l'image",
        dragDrop: "ou glisser-déposer ici",
        compressImage: "Compresser l'image",
        reset: "Réinitialiser",
        status: "",
        compressing: "Compression en cours...",
        compressionComplete: "Compression terminée !",
        error: "Erreur lors de la compression des images.",
        original: "Original",
        compressed: "Compressé",
        download: "Télécharger",
        footer: "© 2025 PixCrunch. Tous droits réservés.",
        compressionLevel: "Niveau de compression :",
        preview: "Aperçu",
        previewTitle: "Aperçu",
        outputFormat: "Format de sortie :"
    },
    es: {
        title: "PixCrunch",
        subtitle: "Reduce el tamaño de tus imágenes fácilmente",
        chooseImage: "Elegir la imagen",
        dragDrop: "o arrastrar y soltar aquí",
        compressImage: "Comprimir la imagen",
        reset: "Restablecer",
        status: "",
        compressing: "Comprimiendo...",
        compressionComplete: "¡Compresión completada!",
        error: "Error al comprimir las imágenes.",
        original: "Original",
        compressed: "Comprimido",
        download: "Descargar",
        footer: "© 2025 PixCrunch. Todos los derechos reservados.",
        compressionLevel: "Nivel de compresión:",
        preview: "Vista previa",
        previewTitle: "Vista previa",
        outputFormat: "Formato de salida:"
    },
    ru: {
        title: "PixCrunch",
        subtitle: "Уменьшайте размер изображений с легкостью",
        chooseImage: "Выбрать изображение",
        dragDrop: "или перетащите сюда",
        compressImage: "Сжать изображение",
        reset: "Сбросить",
        status: "",
        compressing: "Сжатие...",
        compressionComplete: "Сжатие завершено!",
        error: "Ошибка при сжатии изображений.",
        original: "Оригинал",
        compressed: "Сжатый",
        download: "Скачать",
        footer: "© 2025 PixCrunch. Все права защищены.",
        compressionLevel: "Уровень сжатия:",
        preview: "Предпросмотр",
        previewTitle: "Предпросмотр",
        outputFormat: "Формат вывода:"
    },
    pt: {
        title: "PixCrunch",
        subtitle: "Reduza o tamanho das suas imagens com facilidade",
        chooseImage: "Escolher a imagem",
        dragDrop: "ou arrastar e soltar aqui",
        compressImage: "Comprimir a imagem",
        reset: "Redefinir",
        status: "",
        compressing: "Comprimindo...",
        compressionComplete: "Compressão concluída!",
        error: "Erro ao comprimir as imagens.",
        original: "Original",
        compressed: "Comprimido",
        download: "Baixar",
        footer: "© 2025 PixCrunch. Todos os direitos reservados.",
        compressionLevel: "Nível de compressão:",
        preview: "Pré-visualizar",
        previewTitle: "Pré-visualização",
        outputFormat: "Formato de saída:"
    },
    it: {
        title: "PixCrunch",
        subtitle: "Riduci facilmente le dimensioni delle tue immagini",
        chooseImage: "Scegli l'immagine",
        dragDrop: "o trascina e rilascia qui",
        compressImage: "Comprimi l'immagine",
        reset: "Ripristina",
        status: "",
        compressing: "Compressione in corso...",
        compressionComplete: "Compressione completata!",
        error: "Errore durante la compressione delle immagini.",
        original: "Originale",
        compressed: "Compresso",
        download: "Scarica",
        footer: "© 2025 PixCrunch. Tutti i diritti riservati.",
        compressionLevel: "Livello di compressione:",
        preview: "Anteprima",
        previewTitle: "Anteprima",
        outputFormat: "Formato di output:"
    },
    id: {
        title: "PixCrunch",
        subtitle: "Kurangi ukuran gambar Anda dengan mudah",
        chooseImage: "Pilih gambar",
        dragDrop: "atau seret dan lepas di sini",
        compressImage: "Kompres gambar",
        reset: "Setel ulang",
        status: "",
        compressing: "Mengompresi...",
        compressionComplete: "Kompresi selesai!",
        error: "Kesalahan saat mengompresi gambar.",
        original: "Asli",
        compressed: "Terkompresi",
        download: "Unduh",
        footer: "© 2025 PixCrunch. Hak cipta dilindungi.",
        compressionLevel: "Tingkat kompresi:",
        preview: "Pratinjau",
        previewTitle: "Pratinjau",
        outputFormat: "Format keluaran:"
    },
    pl: {
        title: "PixCrunch",
        subtitle: "Zmniejszaj rozmiar swoich zdjęć z łatwością",
        chooseImage: "Wybierz zdjęcie",
        dragDrop: "lub przeciągnij i upuść tutaj",
        compressImage: "Kompresuj zdjęcie",
        reset: "Resetuj",
        status: "",
        compressing: "Kompresowanie...",
        compressionComplete: "Kompresja zakończona!",
        error: "Błąd podczas kompresji zdjęć.",
        original: "Oryginał",
        compressed: "Skompresowany",
        download: "Pobierz",
        footer: "© 2025 PixCrunch. Wszystkie prawa zastrzeżone.",
        compressionLevel: "Poziom kompresji:",
        preview: "Podgląd",
        previewTitle: "Podgląd",
        outputFormat: "Format wyjściowy:"
    },
    th: {
        title: "PixCrunch",
        subtitle: "ลดขนาดภาพของคุณได้อย่างง่ายดาย",
        chooseImage: "เลือกภาพ",
        dragDrop: "หรือลากและวางที่นี่",
        compressImage: "บีบอัดภาพ",
        reset: "รีเซ็ต",
        status: "",
        compressing: "กำลังบีบอัด...",
        compressionComplete: "การบีบอัดเสร็จสิ้น!",
        error: "เกิดข้อผิดพลาดขณะบีบอัดภาพ",
        original: "ต้นฉบับ",
        compressed: "บีบอัดแล้ว",
        download: "ดาวน์โหลด",
        footer: "© 2025 PixCrunch. สงวนลิขสิทธิ์ทั้งหมด",
        compressionLevel: "ระดับการบีบอัด:",
        preview: "ดูตัวอย่าง",
        previewTitle: "ดูตัวอย่าง",
        outputFormat: "รูปแบบผลลัพธ์:"
    },
    ko: {
        title: "PixCrunch",
        subtitle: "이미지 크기를 쉽게 줄이세요",
        chooseImage: "이미지 선택",
        dragDrop: "또는 여기로 드래그 앤 드롭",
        compressImage: "이미지 압축",
        reset: "초기화",
        status: "",
        compressing: "압축 중...",
        compressionComplete: "압축 완료!",
        error: "이미지 압축 중 오류 발생",
        original: "원본",
        compressed: "압축됨",
        download: "다운로드",
        footer: "© 2025 PixCrunch. 모든 권리 보유.",
        compressionLevel: "압축 수준:",
        preview: "미리보기",
        previewTitle: "미리보기",
        outputFormat: "출력 형식:"
    }
};

// Initialize language
let currentLang = 'en';

// DOM elements
const fileInput = document.getElementById('fileInput');
const compressBtn = document.getElementById('compressBtn');
const previewBtn = document.getElementById('previewBtn');
const resetBtn = document.getElementById('resetBtn');
const imageList = document.getElementById('imageList');
const status = document.getElementById('status');
const progress = document.getElementById('progress');
const progressBar = document.querySelector('.progress-bar');
const uploadCard = document.querySelector('.upload-card');
const languageSelect = document.getElementById('languageSelect');
const compressionSlider = document.getElementById('compressionSlider');
const compressionValue = document.getElementById('compressionValue');
const previewArea = document.getElementById('previewArea');
const previewImage = document.getElementById('previewImage');
const previewSize = document.getElementById('previewSize');
const formatSelect = document.getElementById('formatSelect');
const themeToggle = document.getElementById('themeToggle');

let selectedFiles = [];

// Update text based on language
function updateLanguage() {
    document.querySelectorAll('[data-lang]').forEach(element => {
        const key = element.getAttribute('data-lang');
        element.textContent = translations[currentLang][key];
    });
    document.title = `${translations[currentLang].title} - Image Compressor`;
}

// Language change event
languageSelect.addEventListener('change', (e) => {
    currentLang = e.target.value;
    updateLanguage();
    if (selectedFiles.length > 0) {
        displaySelectedImages();
    }
});

// Update compression value display in real-time
compressionSlider.addEventListener('input', () => {
    compressionValue.textContent = `${compressionSlider.value}%`;
});

// File input change - Handles multiple file selection
fileInput.addEventListener('change', () => {
    selectedFiles = Array.from(fileInput.files);
    console.log('Selected files:', selectedFiles.map(file => ({ name: file.name, size: file.size })));
    if (selectedFiles.length === 0) {
        console.warn('No files selected');
        status.textContent = translations[currentLang].error;
        return;
    }
    displaySelectedImages();
    previewArea.classList.add('hidden');
});

// Drag-and-drop events - Supports multiple files
uploadCard.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadCard.classList.add('dragover');
});

uploadCard.addEventListener('dragleave', () => {
    uploadCard.classList.remove('dragover');
});

uploadCard.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadCard.classList.remove('dragover');
    selectedFiles = Array.from(e.dataTransfer.files);
    console.log('Dropped files:', selectedFiles.map(file => ({ name: file.name, size: file.size })));
    if (selectedFiles.length === 0) {
        console.warn('No files dropped');
        status.textContent = translations[currentLang].error;
        return;
    }
    fileInput.files = e.dataTransfer.files;
    displaySelectedImages();
    previewArea.classList.add('hidden');
});

// Preview button click - Previews the first selected image
previewBtn.addEventListener('click', async () => {
    if (selectedFiles.length === 0) {
        console.warn('No files to preview');
        status.textContent = translations[currentLang].error;
        return;
    }

    console.log(`Previewing first image with quality ${compressionSlider.value} and format ${formatSelect.value}`);
    status.textContent = translations[currentLang].compressing;
    progress.classList.remove('hidden');
    animateProgress();

    const formData = new FormData();
    formData.append('images', selectedFiles[0]);
    formData.append('quality', compressionSlider.value);
    formData.append('format', formatSelect.value);

    try {
        const response = await fetch('/preview', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        console.log('Preview response:', data);
        if (!response.ok) {
            throw new Error(data.error || 'Preview failed');
        }
        if (!data.previewImage) {
            throw new Error('No preview image returned');
        }

        previewImage.src = data.previewImage.compressedPath;
        previewSize.textContent = `Estimated Size: ${formatSize(data.previewImage.compressedSize)}`;
        previewArea.classList.remove('hidden');
        status.textContent = '';
        progress.classList.add('hidden');
    } catch (error) {
        console.error('Preview error:', error.message);
        status.textContent = translations[currentLang].error;
        progress.classList.add('hidden');
    }
});

// Compress button click - Compresses all selected images
compressBtn.addEventListener('click', async () => {
    if (selectedFiles.length === 0) {
        console.warn('No files to compress');
        status.textContent = translations[currentLang].error;
        return;
    }
    console.log(`Compressing ${selectedFiles.length} files with quality ${compressionSlider.value} and format ${formatSelect.value}`);
    status.textContent = translations[currentLang].compressing;
    progress.classList.remove('hidden');
    animateProgress();

    const formData = new FormData();
    selectedFiles.forEach((file, index) => {
        formData.append('images', file);
        console.log(`Added file ${index + 1}: ${file.name}`);
    });
    formData.append('quality', compressionSlider.value);
    formData.append('format', formatSelect.value);

    try {
        const response = await fetch('/compress', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        console.log('Server response:', data);
        if (!response.ok) {
            throw new Error(data.error || 'Compression failed');
        }
        if (!data.compressedImages || data.compressedImages.length === 0) {
            throw new Error('No compressed images returned');
        }
        displayCompressedImages(data.compressedImages);
        status.textContent = translations[currentLang].compressionComplete;
        progress.classList.add('hidden');
        previewArea.classList.add('hidden');
    } catch (error) {
        console.error('Compression error:', error.message);
        status.textContent = translations[currentLang].error;
        progress.classList.add('hidden');
    }
});

// Reset button click
resetBtn.addEventListener('click', () => {
    fileInput.value = '';
    selectedFiles = [];
    imageList.innerHTML = '';
    status.textContent = translations[currentLang].status;
    progress.classList.add('hidden');
    compressionSlider.value = 50;
    compressionValue.textContent = '50%';
    previewArea.classList.add('hidden');
    formatSelect.value = 'jpeg';
    console.log('Reset completed!');
});

// Display selected images - Shows all selected images in a grid
function displaySelectedImages() {
    imageList.innerHTML = '';
    if (selectedFiles.length === 0) {
        console.warn('No images to display!');
        return;
    }
    selectedFiles.forEach(file => {
        const item = document.createElement('div');
        item.className = 'image-item';
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        const name = document.createElement('p');
        name.textContent = file.name;
        const size = document.createElement('p');
        size.textContent = `${translations[currentLang].original}: ${formatSize(file.size)}`;
        item.appendChild(img);
        item.appendChild(name);
        item.appendChild(size);
        imageList.appendChild(item);
    });
    console.log(`Displayed ${selectedFiles.length} images`);
}

// Display compressed images - Adds compressed sizes and download links for all images
function displayCompressedImages(compressedImages) {
    console.log('Received compressed images:', compressedImages);
    if (!compressedImages || compressedImages.length !== selectedFiles.length) {
        console.error(`Expected ${selectedFiles.length} compressed images, but received ${compressedImages ? compressedImages.length : 0}`);
        status.textContent = translations[currentLang].error;
        return;
    }
    compressedImages.forEach((imgData, index) => {
        const item = imageList.children[index];
        if (!item) {
            console.error(`No item found for index ${index}`);
            return;
        }
        const compressedSize = document.createElement('p');
        compressedSize.textContent = `${translations[currentLang].compressed}: ${formatSize(imgData.compressedSize)}`;
        const downloadBtn = document.createElement('a');
        downloadBtn.href = imgData.compressedPath;
        downloadBtn.download = imgData.compressedName || `${selectedFiles[index].name.split('.')[0]}_compressed.${imgData.format}`;
        downloadBtn.textContent = translations[currentLang].download;
        downloadBtn.className = 'download-btn';
        item.appendChild(compressedSize);
        item.appendChild(downloadBtn);
        console.log(`Added compressed info for ${imgData.originalName}`);
    });
}

// Format file size
function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' bytes';
    else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// Animate progress bar
function animateProgress() {
    let width = 0;
    progressBar.style.width = '0%';
    const totalSteps = Math.max(10, selectedFiles.length * 2);
    const increment = 90 / totalSteps;
    const interval = setInterval(() => {
        if (width >= 90) {
            clearInterval(interval);
            return;
        }
        width += increment;
        progressBar.style.width = `${width}%`;
    }, 200);
}

// Function to toggle theme
function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
    themeToggle.textContent = isDarkMode ? '☀️' : '🌙';
}

// Load saved theme on page load
function loadTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.textContent = '☀️';
    } else {
        themeToggle.textContent = '🌙';
    }
}

// Theme toggle event listener
themeToggle.addEventListener('click', toggleTheme);

// Initialize language and theme on page load
updateLanguage();
loadTheme();